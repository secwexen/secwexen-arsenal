import os
import hashlib
from typing import List

from utils import log_info, log_warning, log_error


# Default scan configuration
SUSPICIOUS_EXTENSIONS = {
    ".exe",
    ".dll",
    ".scr",
    ".bat",
    ".cmd",
    ".ps1",
    ".vbs",
    ".js",
    ".jar",
    ".php",
    ".asp",
    ".aspx",
    ".jsp",
}

SUSPICIOUS_KEYWORDS = {
    "mimikatz",
    "meterpreter",
    "cobalt",
    "beacon",
    "keylogger",
    "backdoor",
    "shellcode",
    "ransom",
}

# Example hash blacklist (to be extended in real use)
KNOWN_MALICIOUS_HASHES = {
    # "sha256-hash-here": "Description / Family"
}


def compute_sha256(path: str) -> str:
    """
    Compute SHA256 hash for a file.

    :param path: File path
    :return: Hex digest string
    """
    sha256 = hashlib.sha256()
    with open(path, "rb") as f:
        for chunk in iter(lambda: f.read(8192), b""):
            sha256.update(chunk)
    return sha256.hexdigest()


def is_suspicious_extension(path: str) -> bool:
    """
    Check if file extension is commonly used for malware.

    :param path: File path
    :return: True if suspicious, False otherwise
    """
    _, ext = os.path.splitext(path)
    return ext.lower() in SUSPICIOUS_EXTENSIONS


def is_suspicious_name(path: str) -> bool:
    """
    Check if file name contains suspicious keywords.

    :param path: File path
    :return: True if suspicious, False otherwise
    """
    lower_name = os.path.basename(path).lower()
    return any(keyword in lower_name for keyword in SUSPICIOUS_KEYWORDS)


def check_hash_blacklist(file_hash: str) -> str | None:
    """
    Check if file hash is in known malicious hash list.

    :param file_hash: SHA256 hex digest
    :return: Description if malicious, else None
    """
    return KNOWN_MALICIOUS_HASHES.get(file_hash)


def scan_file(path: str) -> List[str]:
    """
    Scan a single file using simple heuristics and hash blacklist.

    :param path: File path
    :return: List of detection messages
    """
    findings: List[str] = []

    if not os.path.isfile(path):
        return findings

    try:
        file_hash = compute_sha256(path)
    except Exception as e:
        log_error(f"[MALWARE] Failed to hash file {path}: {e}")
        return findings

    # Hash blacklist check
    blacklist_hit = check_hash_blacklist(file_hash)
    if blacklist_hit:
        findings.append(f"HASH_MATCH: Known malware ({blacklist_hit})")

    # Extension heuristic
    if is_suspicious_extension(path):
        findings.append("SUSPICIOUS_EXTENSION")

    # Name heuristic
    if is_suspicious_name(path):
        findings.append("SUSPICIOUS_NAME")

    return findings


def scan_directory(target_dir: str) -> dict:
    """
    Recursively scan a directory for suspicious files.

    :param target_dir: Directory to scan
    :return: Dict mapping file paths to list of findings
    """
    if not os.path.isdir(target_dir):
        log_error(f"[MALWARE] Target directory not found: {target_dir}")
        return {}

    log_info(f"[MALWARE] Starting scan in: {target_dir}")

    results: dict[str, List[str]] = {}

    for root, _, files in os.walk(target_dir):
        for name in files:
            path = os.path.join(root, name)

            findings = scan_file(path)
            if findings:
                results[path] = findings
                log_warning(f"[MALWARE] Suspicious file: {path} -> {', '.join(findings)}")

    if not results:
        log_info("[MALWARE] No suspicious files detected.")
    else:
        log_warning(f"[MALWARE] Scan completed with {len(results)} suspicious file(s).")

    return results


def scan_for_malware(target_dir: str | None = None) -> dict:
    """
    Public entry point for malware scanning.

    :param target_dir: Directory to scan. Defaults to current working directory.
    :return: Dict of suspicious files and their findings
    """
    if target_dir is None:
        target_dir = os.getcwd()

    return scan_directory(target_dir)


if __name__ == "__main__":
    # Simple CLI usage: python malware_scanner.py [path]
    import sys

    target = sys.argv[1] if len(sys.argv) > 1 else os.getcwd()
    scan_for_malware(target)
